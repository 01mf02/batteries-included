BYTE_ENABLED   = true
NATIVE_ENABLED = true

USE_OCAMLFIND = true
OCAMLCFLAGS += -g

OCAMLDEP_MODULES_ENABLED = false
OCAMLROOT = $(shell ocamlc -where)
DOCROOT = /usr/share/doc/ocaml-aaa/
BROWSER_COMMAND = x-www-browser %s


NAME = aaa
VERSION = 2009.11


.PHONY: doc uninstall install all clean test reinstall
clean:
    rm -f $(filter-proper-targets $(ls R, .))

.SUBDIRS: src

all: src/batteries.cmxa src/batteries.cma

build/META: build/META.in
	rm(-f build/META)
	sed -e 's|@VERSION@|$(VERSION)|' \
	    build/META.in > build/META
	chmod(444 build/META)

uninstall:
	$(OCAMLFIND) remove $(NAME)

install: all build/META
	$(OCAMLFIND) install $(NAME) build/META \
	src/*.mli src/*.cmi src/*.cma src/*.cmxa src/*.a
	$(INSTALL) aaa $(OCAMLROOT)

doc: src/batteries.cma
	mkdir -p hdoc
	$(OCAMLFIND) ocamldoc -package camomile -package threads.posix \
	-sort -html -d hdoc -I src src/*.mli

install-doc: doc
	$(INSTALL) -d $(DOCROOT)
	$(INSTALL) hdoc/* $(DOCROOT)
	$(INSTALL) doc/batteries/*.idex doc/batteries/*.help $(DOCROOT)

reinstall: uninstall install install-doc

test: all
	cd testsuite && ocamlbuild main.native main.byte
	testsuite/main.native
	testsuite/main.byte

release: 
	false

.DEFAULT: all

