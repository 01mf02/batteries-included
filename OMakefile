BYTE_ENABLED   = true
NATIVE_ENABLED = true

USE_OCAMLFIND = true
OCAMLPACKS[] +=
    camomile
    num
    str
    threads

#zip_pack = $(shell ocamlfind list | grep "zip\ " | cut -d\  -f1)
#OCAMLPACKS[] += $(zip_pack)

OCAMLFLAGS += -thread
OCAMLCFLAGS += -g

OCAMLDEP_MODULES_ENABLED = false
OCAMLROOT = $(shell ocamlfind printconf destdir)
DOCROOT = /usr/share/doc/ocaml-aaa/
BROWSER_COMMAND = x-www-browser %s

NAME = aaa
VERSION = 2009.11

LIBSDIR = $(ROOT)/libs

.PHONY: doc uninstall install all clean test reinstall
clean:
    rm -f $(filter-proper-targets $(ls R, .))

AAA_FILES[] =
EXTLIB_COMPAT_FILES[] =

.SUBDIRS: src testsuite
    include OMakefile
    export AAA_FILES EXTLIB_COMPAT_FILES

.SUBDIRS: libs
    .SUBDIRS: estring
        include OMakefile
        export AAA_FILES EXTLIB_COMPAT_FILES

build/META: build/META.in
	rm(-f build/META)
	sed -e 's|@VERSION@|$(VERSION)|' \
	    build/META.in > build/META
	chmod(444 build/META)

build/extlibcompat/META: build/extlibcompat/META.in
	rm(-f $@)
	sed -e 's|@VERSION@|$(VERSION)|' $< > $@
	chmod(444 $@)

uninstall:
	$(OCAMLFIND) remove $(NAME)
	$(OCAMLFIND) remove $(NAME)-extlibcompat

install: all build/META build/extlibcompat/META
	$(OCAMLFIND) install $(NAME) build/META $(AAA_FILES)
	$(OCAMLFIND) install $(NAME)-extlibcompat build/extlibcompat/META $(EXTLIB_COMPAT_FILES)

doc: src/batteries.cma
	mkdir -p hdoc
	$(OCAMLFIND) ocamldoc -package camomile -package threads.posix \
	-sort -html -d hdoc -I src src/*.mli

install-doc: doc
	$(INSTALL) -d $(DOCROOT)
	$(INSTALL) hdoc/* $(DOCROOT)
	$(INSTALL) doc/batteries/*.idex doc/batteries/*.help $(DOCROOT)

reinstall: uninstall install install-doc

test: testsuite/main.opt testsuite/main.run
	testsuite/main.opt && testsuite/main.run

release: 
	false

.DEFAULT: all

