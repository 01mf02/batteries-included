#!/usr/bin/make -f
include /usr/share/cdbs/1/class/autotools.mk
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/rules/patchsys-quilt.mk
include /usr/share/cdbs/1/rules/ocaml.mk
-include /usr/share/topgit/tg2quilt.mk

LIB_NAME = batteries
DEV_PKG_NAME = lib$(LIB_NAME)-ocaml-dev
DOC_PKG_NAME = lib$(LIB_NAME)-ocaml-doc
DEST_DIR = $(CURDIR)/debian/$(DEV_PKG_NAME)$(OCAML_STDLIB_DIR)
QUILT_PATCH_DIR ?= debian/patches	# can be removed once #513952 gets fixed
DEB_AUTO_UPDATE_AUTOCONF = yes

OCAMLBUILD_FLAGS = -classic-display
DEB_CONFIGURE_EXTRA_FLAGS = --with-browser="x-www-browser %s"
DEB_CONFIGURE_EXTRA_FLAGS += --with-docroot="/usr/share/doc/$(DOC_PKG_NAME)"
DEB_MAKE_BUILD_TARGET = all
ifeq ($(OCAML_HAVE_OCAMLOPT),yes)
DEB_MAKE_BUILD_TARGET += opt
else
OCAMLBUILD_FLAGS += -byte-plugin
endif
DEB_MAKE_BUILD_TARGET += OBFLAGS="$(OCAMLBUILD_FLAGS)"
DEB_MAKE_INSTALL_TARGET = install DESTDIR=$(DEST_DIR)
DEB_MAKE_CLEAN_TARGET = clean

DEB_COMPRESS_EXCLUDE += myocamlbuild.ml
DEB_COMPRESS_EXCLUDE += .idex

build/$(DOC_PKG_NAME)::
	OCAMLRUNPARAM=l=16M make doc OBFLAGS=-classic-display
	/usr/share/cdbs/1/class/ocamldoc-api-ref-config \
		--doc-base-generate $(DEV_PKG_NAME)
	mv debian/$(DEV_PKG_NAME).doc-base.ocamldoc-apiref \
		debian/$(DOC_PKG_NAME).doc-base.ocamldoc-apiref
